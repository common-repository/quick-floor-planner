var activeLine,canvas,min=99,max=999999,polygonMode=!0,pointArray=new Array,lineArray=new Array,activeShape=!1;jQuery(window).load(function(){prototypefabric.initCanvas(),jQuery("#qfp-create-polygon").click(function(){prototypefabric.polygon.drawPolygon()})});var prototypefabric=new function(){this.initCanvas=function(){(canvas=window._canvas=new fabric.Canvas("qfp-canvas",{backgroundColor:"#edecee"})).setWidth(650),canvas.setHeight(450),document.getElementById("qfp-addArc").onclick=function(){var e=new fabric.Circle({radius:20,left:50,top:180,angle:45,startAngle:0,endAngle:Math.PI,stroke:"#000",strokeWidth:3,fill:""});canvas.add(e).setActiveObject(e)},document.getElementById("qfp-addRect").onclick=function(){var e=new fabric.Rect({top:100,left:0,width:80,height:50,fill:"#c4c3c5"});canvas.add(e).setActiveObject(e)},document.getElementById("qfp-addCircle").onclick=function(){var e=new fabric.Circle({radius:40,fill:"#c4c3c5",left:100,top:100});canvas.add(e).setActiveObject(e)},document.getElementById("qfp-addDoor").onclick=function(){var e=new fabric.Circle({radius:20,left:50,top:182,angle:27,startAngle:19.3,endAngle:Math.PI-.1,stroke:"#000",strokeWidth:1,fill:""}),a=new fabric.Line([30,100,30,130],{left:67,top:200,stroke:"#edecee",strokeWidth:5}),n=new fabric.Line([15,100,50,100],{left:37,top:200,stroke:"#000",strokeWidth:5}),t=new fabric.Group([e,a,n],{});canvas.add(t).setActiveObject(t)},document.getElementById("qfp-addLine").onclick=function(){var e=new fabric.Line([50,100,200,200],{left:170,top:150,stroke:"#000",strokeWidth:5});canvas.add(e).setActiveObject(e)},document.getElementById("qfp-addWindow").onclick=function(){var e=new fabric.Line([50,100,100,100],{left:170,top:150,stroke:"#000",strokeWidth:4}),a=new fabric.Line([50,100,100,100],{left:170,top:155,stroke:"#000",strokeWidth:4}),n=new fabric.Group([e,a],{});canvas.add(n).setActiveObject(n)},document.getElementById("qfp-imageLoader").addEventListener("change",function(e){var a=canvas.getObjects();for(var n in a)a[n].remove();var t=new FileReader;t.onload=function(e){var a=new Image;a.onload=function(){var e=new fabric.Image(a,{selectable:1});canvas.add(e),canvas.deactivateAll().renderAll()},a.src=e.target.result},t.readAsDataURL(e.target.files[0])},!1),document.getElementById("qfp-lnkDownload").addEventListener("click",function(e){this.href=canvas.toDataURL({format:"png",quality:.8}),this.download="quick-floor-plan.png"},!1),fabric.Object.prototype.transparentCorners=!1,canvas.on("mouse:down",function(e){e.target&&e.target.id==pointArray[0].id&&prototypefabric.polygon.generatePolygon(pointArray),polygonMode&&prototypefabric.polygon.addPoint(e)}),canvas.on("mouse:up",function(e){}),canvas.on("mouse:move",function(e){if(activeLine&&"line"==activeLine.class){var a=canvas.getPointer(e.e);activeLine.set({x2:a.x,y2:a.y});var n=activeShape.get("points");n[pointArray.length]={x:a.x,y:a.y},activeShape.set({points:n}),canvas.renderAll()}canvas.renderAll()})}};prototypefabric.polygon={drawPolygon:function(){polygonMode=!0,pointArray=new Array,lineArray=new Array},addPoint:function(e){var a=Math.floor(Math.random()*(max-min+1))+min,n=(new Date).getTime()+a,t=new fabric.Circle({radius:5,fill:"#ffffff",stroke:"#333333",strokeWidth:2,left:e.e.layerX/canvas.getZoom(),top:e.e.layerY/canvas.getZoom(),selectable:!1,hasBorders:!1,hasControls:!1,originX:"center",originY:"center",id:n,objectCaching:!1});0==pointArray.length&&t.set({fill:"#000"});var o=[e.e.layerX/canvas.getZoom(),e.e.layerY/canvas.getZoom(),e.e.layerX/canvas.getZoom(),e.e.layerY/canvas.getZoom()];if(line=new fabric.Line(o,{strokeWidth:2,fill:"#999999",stroke:"#999999",class:"line",originX:"center",originY:"center",selectable:!1,hasBorders:!1,hasControls:!1,evented:!1,objectCaching:!1}),activeShape){var c=canvas.getPointer(e.e);(o=activeShape.get("points")).push({x:c.x,y:c.y});var r=new fabric.Polygon(o,{stroke:"#333333",strokeWidth:1,fill:"#cccccc",opacity:.3,selectable:!1,hasBorders:!1,hasControls:!1,evented:!1,objectCaching:!1});canvas.remove(activeShape),canvas.add(r),activeShape=r,canvas.renderAll()}else{var i=[{x:e.e.layerX/canvas.getZoom(),y:e.e.layerY/canvas.getZoom()}];r=new fabric.Polygon(i,{stroke:"#333333",strokeWidth:1,fill:"#cccccc",opacity:.3,selectable:!1,hasBorders:!1,hasControls:!1,evented:!1,objectCaching:!1}),activeShape=r,canvas.add(r)}activeLine=line,pointArray.push(t),lineArray.push(line),canvas.add(line),canvas.add(t),canvas.selection=!1},generatePolygon:function(e){var a=new Array;jQuery.each(e,function(e,n){a.push({x:n.left,y:n.top}),canvas.remove(n)}),jQuery.each(lineArray,function(e,a){canvas.remove(a)}),canvas.remove(activeShape).remove(activeLine);var n=new fabric.Polygon(a,{stroke:"#000",strokeWidth:6,fill:"#fff",opacity:1,hasBorders:!1,hasControls:!1});canvas.add(n),canvas.sendToBack(n),activeLine=null,activeShape=null,polygonMode=!1,canvas.selection=!0}};